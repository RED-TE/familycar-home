<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ê´€ë¦¬ì | íŒ¨ë°€ë¦¬ì˜¤í† í”Œëœ ë¬¸ì˜ ê´€ë¦¬</title>
<meta name="color-scheme" content="light only"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#ffffff; --card:#f8fafc; --text:#0f172a; --muted:#475569; --line:rgba(15,23,42,.08);
  --brand:#16a34a; --accent:#0ea5e9; --red:#ef4444; --amber:#f59e0b; --ok:#10b981;
  --radius:14px; --shadow:0 10px 26px rgba(0,0,0,.08);
}
*{box-sizing:border-box} body{margin:0;background:#fff;color:var(--text);font:14.5px/1.6 "Noto Sans KR",system-ui}
a{color:inherit;text-decoration:none}
.container{width:min(1200px,94%);margin:0 auto}

.header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:10}
.header .row{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.brand{font-weight:900;display:flex;gap:.55rem;align-items:center}
.badge{font-size:12px;padding:.2rem .5rem;border:1px solid var(--line);border-radius:999px;color:#065f46;background:rgba(34,197,94,.10)}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.toolbar{margin:14px 0;display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
.toolbar .filters{display:flex;gap:8px;flex-wrap:wrap}
.toolbar input[type="search"]{width:100%;padding:.8rem 1rem;border-radius:10px;border:1px solid var(--line);background:#fff}
.btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--line);background:#fff;padding:.7rem 1rem;border-radius:10px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff;border-color:transparent}
.btn.danger{background:#fff;color:#b91c1c;border-color:#fecaca}
.btn.small{padding:.45rem .7rem;font-weight:700;border-radius:8px}
.select{padding:.7rem .9rem;border:1px solid var(--line);border-radius:10px;background:#fff}

.table{overflow:auto;border-radius:var(--radius);border:1px solid var(--line)}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{padding:10px;border-bottom:1px solid #eef2f7;vertical-align:top}
th{white-space:nowrap;text-align:left;background:#f9fafb;font-weight:800;color:#334155}
tbody tr:hover{background:#fcfdfd}
.status{display:inline-flex;align-items:center;gap:.35rem;font-weight:800;border-radius:999px;padding:.2rem .55rem;border:1px solid var(--line)}
.status.new{background:#ecfeff;color:#0369a1}
.status.in_progress{background:#fff7ed;color:#9a3412}
.status.done{background:#ecfdf5;color:#065f46}
.status.absent{background:#f1f5f9;color:#1e293b}
.status.potential{background:#fefce8;color:#854d0e}
.status.rejected{background:#fef2f2;color:#991b1b}
.status.contract{background:#ecfdf5;color:#047857}
.kv{display:flex;gap:6px;flex-wrap:wrap}
.kv b{color:#334155}

.login{min-height:100dvh;display:grid;place-items:center}
.login .panel{width:min(420px,94%);padding:18px}
.login h1{margin:0 0 8px}
.login p{color:var(--muted);margin-top:0}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);padding:20px;z-index:20}
.modal .panel{width:min(720px,94%);padding:18px}
.modal .actions{text-align:right;margin-top:12px}
textarea{width:100%;min-height:100px;border:1px solid var(--line);border-radius:10px;padding:.75rem 1rem}
</style>
</head>
<body>

<div id="app">
  <!-- ë¡œê·¸ì¸ -->
  <section class="login" id="loginView">
    <div class="container">
      <div class="card panel">
        <h1>ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
        <p>ìŠ¹ì¸ëœ ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
        <div style="display:grid;gap:10px">
          <input id="email" type="email" placeholder="ì´ë©”ì¼" />
          <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
          <button class="btn primary" id="btnLogin">ë¡œê·¸ì¸</button>
        </div>
        <div id="loginMsg" style="color:#b91c1c;margin-top:8px"></div>
      </div>
    </div>
  </section>

  <!-- ëŒ€ì‹œë³´ë“œ -->
  <section id="dashView" style="display:none">
    <div class="header">
      <div class="container row">
        <div class="brand">ğŸ“Š ë¬¸ì˜ ëŒ€ì‹œë³´ë“œ <span class="badge" id="userBadge">-</span></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="btnExport">CSV ë‚´ë³´ë‚´ê¸°</button>
          <button class="btn danger" id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="toolbar">
        <input type="search" id="q" placeholder="ì´ë¦„/ì—°ë½ì²˜/ë¸Œëœë“œ/ìƒí’ˆ ê²€ìƒ‰â€¦" />
        <select id="dateRange" class="select">
          <option value="all">ì „ì²´ê¸°ê°„</option>
          <option value="today">ì˜¤ëŠ˜</option>
          <option value="7d">ìµœê·¼ 7ì¼</option>
        </select>
        <select id="status" class="select">
          <option value="all">ì „ì²´ìƒíƒœ</option>
          <option value="new">ì‹ ê·œ</option>
          <option value="in_progress">ì§„í–‰ì¤‘</option>
          <option value="done">ì™„ë£Œ</option>
        </select>
        <div class="filters">
          <select id="pageSize" class="select">
            <option>20</option><option>50</option><option>100</option>
          </select>
          <button class="btn" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>

      <div class="table card">
        <table id="tbl">
          <thead>
            <tr>
              <th>ì‘ì„±</th>
              <th>ê³ ê°</th>
              <th>ì—°ë½ì²˜</th>
              <th>ë¸Œëœë“œ/ìƒí’ˆ</th>
              <th>ì°¨ì¢…/ì¡°ê±´</th>
              <th>ë©”ëª¨</th>
              <th>ìƒíƒœ</th>
              <th>ì‘ì—…</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="loading" style="display:none;margin:10px 0;color:#64748b">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin:12px 0 40px">
        <div id="count"></div>
        <div style="display:flex;gap:6px">
          <button class="btn small" id="prev">ì´ì „</button>
          <button class="btn small" id="next">ë‹¤ìŒ</button>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- ë©”ëª¨ ëª¨ë‹¬ -->
<div class="modal" id="memoModal">
  <div class="card panel">
    <h3 style="margin-top:0">ë©”ëª¨ ì—…ë°ì´íŠ¸</h3>
    <textarea id="memoText" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <div class="actions">
      <button class="btn" data-close>ì·¨ì†Œ</button>
      <button class="btn primary" id="saveMemo">ì €ì¥</button>
    </div>
  </div>
</div>

<div class="modal" id="detailModal">
  <div class="card panel">
    <h3 style="margin-top:0">ë¬¸ì˜ ìƒì„¸</h3>
    <div id="detailBody" style="white-space:pre-wrap"></div>
    <div class="actions">
      <button class="btn" data-close>ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

// ===== Firebase ì„¤ì • =====
const firebaseConfig = {
  apiKey: "AIzaSyBp5RDs87mLocfgPZ-oI_GfQ-Lr8SM4xK0",
  authDomain: "familyauto-71c11.firebaseapp.com",
  projectId: "familyauto-71c11",
  storageBucket: "familyauto-71c11.firebasestorage.app",
  messagingSenderId: "251564150896",
  appId: "1:251564150896:web:9bc80da30329ee9cf0e4b5",
  measurementId: "G-PVBC1NH5TG"
};

initializeApp(firebaseConfig);
const auth = getAuth();
const db   = getFirestore();

// ===== DOM =====
const loginView = document.getElementById('loginView');
const dashView  = document.getElementById('dashView');
const loginMsg  = document.getElementById('loginMsg');
const userBadge = document.getElementById('userBadge');

const qEl = document.getElementById('q');
const statusEl = document.getElementById('status');
const pageSizeEl = document.getElementById('pageSize');
const dateRangeEl = document.getElementById('dateRange');
const loadingEl = document.getElementById('loading');
const countEl = document.getElementById('count');
const tbody = document.querySelector('#tbl tbody');

let ALL = []; // ë©”ëª¨ë¦¬ì— ì ì¬í•´ì„œ í•„í„°/ê²€ìƒ‰/í˜ì´ì§€ë„¤ì´ì…˜
let page = 1;
let unsubscribe = null;

// ===== ë¡œê·¸ì¸ & ê¶Œí•œ =====

document.getElementById('btnLogin').addEventListener('click', async () => {
  loginMsg.textContent = '';
  const email = (document.getElementById('email').value||'').trim();
  const password = document.getElementById('password').value||'';
  try {
    await signInWithEmailAndPassword(auth, email, password);
    // onAuthStateChangedê°€ ì´ì–´ì„œ ì‹¤í–‰ë¨
  } catch (e) {
    loginMsg.textContent = e.message;
  }
});

document.getElementById('btnLogout').addEventListener('click', async () => {
  try { await signOut(auth); } catch(_){}
});

onAuthStateChanged(auth, async (user) => {
  if (!user) { showLogin(); return; }
  try {
    // users/{uid} ë¬¸ì„œì˜ role === 'admin' í™•ì¸
    const snap = await getDoc(doc(db, 'users', user.uid));
    const role = snap.exists() ? snap.data().role : null;
    if (role !== 'admin') {
      loginMsg.textContent = 'ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
      await signOut(auth);
      showLogin();
      return;
    }
    userBadge.textContent = user.email || 'ê´€ë¦¬ì';
    showDash();
  } catch (e) {
    loginMsg.textContent = 'ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ' + e.message;
    await signOut(auth);
    showLogin();
  }
});

function showLogin(){ loginView.style.display='grid'; dashView.style.display='none'; }
function showDash(){ loginView.style.display='none'; dashView.style.display='block'; refreshAndLoad(); }

// ===== ë°ì´í„° ë¡œë”©/ë Œë”ë§ =====

document.getElementById('btnRefresh').onclick = () => { page=1; refreshAndLoad(); };
document.getElementById('prev').onclick = () => { if(page>1){ page--; render(); } };
document.getElementById('next').onclick = () => {
  const ps = Number(pageSizeEl.value);
  if (page * ps < ALL.length) { page++; render(); }
};
qEl.oninput = debounce(() => { page=1; render(); }, 300);
statusEl.onchange = () => { page=1; render(); };
pageSizeEl.onchange = () => { page=1; render(); };
dateRangeEl.onchange = () => { page=1; render(); };

async function refreshAndLoad(){
  // ì‹¤ì‹œê°„ êµ¬ë… ì‹œì‘
  startRealtime();
}

function startRealtime(){
  loadingEl.style.display = 'block';
  // ê¸°ì¡´ êµ¬ë… í•´ì œ
  if (typeof unsubscribe === 'function') { unsubscribe(); unsubscribe = null; }

  const qRef = query(collection(db, 'inquiries'), orderBy('createdAt','desc'), limit(1000));
  unsubscribe = onSnapshot(qRef, (snap) => {
    const raw = snap.docs.map(d => ({ id:d.id, ...d.data() }));

    // ë‚ ì§œ í•„í„°ëŠ” ë Œë” ë‹¨ê³„ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì›ë³¸ì„ ì €ì¥
    ALL = raw;

    page = 1;
    render();
    loadingEl.style.display = 'none';
  }, (err) => {
    console.error('[admin] onSnapshot error:', err);
    loadingEl.style.display = 'none';
    alert('ì‹¤ì‹œê°„ êµ¬ë… ì˜¤ë¥˜: ' + (err.message || err));
  });
}

// (ë¯¸ì‚¬ìš©) onSnapshot ì‹¤ì‹œê°„ ëª¨ë“œë¡œ ëŒ€ì²´ë¨
async function fetchInquiries(){
  const baseQ = query(collection(db, 'inquiries'), orderBy('createdAt','desc'), limit(1000));
  const snap = await getDocs(baseQ);
  const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  // ë‚ ì§œ í•„í„°(í´ë¼ì´ì–¸íŠ¸)
  const now = new Date();
  let startDate;
  if (dateRangeEl.value === 'today') {
    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  } else if (dateRangeEl.value === '7d') {
    startDate = new Date(now.getTime() - 7*24*60*60*1000);
  }
  return list.filter(r => {
    if (!startDate) return true; // ì „ì²´ê¸°ê°„
    const t = toDate(r.createdAt);
    return t ? (t >= startDate) : true;
  });
}

function render(){
  const ps = Number(pageSizeEl.value);
  let rows = [...ALL];

  // ë‚ ì§œ í•„í„° (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
  const now = new Date();
  let startDate;
  if (dateRangeEl.value === 'today') {
    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  } else if (dateRangeEl.value === '7d') {
    startDate = new Date(now.getTime() - 7*24*60*60*1000);
  }
  if (startDate) {
    rows = rows.filter(r => {
      const t = toDate(r.createdAt);
      return t ? (t >= startDate) : true;
    });
  }

  // ìƒíƒœ í•„í„° (íˆ´ë°” ì„ íƒê°’ê³¼ ë™ì¼í•œ ê²½ìš°ë§Œ í•„í„°)
  if (statusEl.value !== 'all') rows = rows.filter(r => r.status === statusEl.value);

  // í…ìŠ¤íŠ¸ ê²€ìƒ‰ (ì´ë¦„/ì „í™”/ë¸Œëœë“œ/ìƒí’ˆ/ëª¨ë¸/ì¡°ê±´/ë©”ì‹œì§€)
  const s = qEl.value.trim().toLowerCase();
  if (s) {
    rows = rows.filter(r => [r.name, r.phone, r.brand, r.product, r.model, r.terms, r.message]
      .some(v => (v||'').toString().toLowerCase().includes(s)));
  }

  // createdAt desc ì •ë ¬
  rows.sort((a,b)=> {
    const da = toDate(a.createdAt) || new Date(0);
    const db = toDate(b.createdAt) || new Date(0);
    return db - da;
  });

  const total = rows.length;
  const from = (page-1)*ps;
  const pageRows = rows.slice(from, from+ps);

  tbody.innerHTML = '';
  for (const r of pageRows){
    const created = toDate(r.createdAt);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="white-space:nowrap">${created?created.toLocaleString('ko-KR'):''}</td>
      <td><div class="kv"><b>${esc(r.name)||'-'}</b></div></td>
      <td>
        <div>${esc(fmtPhone(r.phone))||'-'}</div>
        <button class="btn small" data-copy="${esc(r.phone)||''}">ë³µì‚¬</button>
      </td>
      <td><div>${esc(r.brand)||'-'} / ${esc(r.product)||'-'}</div></td>
      <td><div>${esc(r.model)||'-'}<br><span style="color:#64748b">${esc(r.terms)||''}</span></div></td>
      <td>
        <div style="max-width:280px;white-space:pre-wrap">${esc(r.memo||'')}</div>
        <button class="btn small" data-memo="${r.id}">ë©”ëª¨</button>
      </td>
      <td>
        <select data-status="${r.id}" class="select">
          <option value="absent" ${r.status==='absent'?'selected':''}>ë¶€ì¬</option>
          <option value="potential" ${r.status==='potential'?'selected':''}>ê°€ë§</option>
          <option value="rejected" ${r.status==='rejected'?'selected':''}>ë¶€ê²°</option>
          <option value="contract" ${r.status==='contract'?'selected':''}>ê³„ì•½</option>
          <option value="new" ${r.status==='new'?'selected':''}>ì‹ ê·œ</option>
          <option value="in_progress" ${r.status==='in_progress'?'selected':''}>ì§„í–‰ì¤‘</option>
          <option value="done" ${r.status==='done'?'selected':''}>ì™„ë£Œ</option>
        </select>
      </td>
      <td>
        <button class="btn small" data-detail="${r.id}">ìƒì„¸</button>
      </td>`;
    tbody.appendChild(tr);
  }

  countEl.textContent = `ì´ ${total}ê±´ Â· ${page}/${Math.max(1, Math.ceil(total/ps))}í˜ì´ì§€`;
}

// ===== ì´ë²¤íŠ¸ ìœ„ì„ =====

tbody.addEventListener('click', async (e)=>{
  const copyBtn = e.target.closest('[data-copy]');
  if(copyBtn){ await navigator.clipboard.writeText(copyBtn.dataset.copy||''); copyBtn.textContent='ë³µì‚¬ë¨'; setTimeout(()=>copyBtn.textContent='ë³µì‚¬',1200); }

  const detailBtn = e.target.closest('[data-detail]');
  if(detailBtn){ const id=detailBtn.dataset.detail; const d = ALL.find(x=>x.id===id); if(!d) return; showDetail(d); }

  const memoBtn = e.target.closest('[data-memo]');
  if(memoBtn){ openMemo(memoBtn.dataset.memo); }
});

tbody.addEventListener('change', async (e)=>{
  const sel = e.target.closest('select[data-status]');
  if(!sel) return;
  const id = sel.dataset.status;
  try{
    await updateDoc(doc(db,'inquiries', id), { status: sel.value });
    const t = ALL.find(x=>x.id===id); if(t) t.status = sel.value; // ë¡œì»¬ ë°˜ì˜
  }catch(err){ alert(err.message); }
});

function showDetail(r){
  const created = toDate(r.createdAt);
  const detail = [
    `ì‘ì„±: ${created?created.toLocaleString('ko-KR'):''}`,
    `ì´ë¦„: ${r.name||'-'}`,
    `ì—°ë½ì²˜: ${r.phone||'-'}`,
    `ë¸Œëœë“œ/ìƒí’ˆ: ${r.brand||'-'} / ${r.product||'-'}`,
    `ì°¨ì¢…: ${r.model||'-'}`,
    `ì¡°ê±´: ${r.terms||'-'}`,
    `ë©”ì‹œì§€: ${r.message||'-'}`,
    `ìƒíƒœ: ${r.status||'-'}`,
    `Referrer: ${r.referrer||'-'}`,
    `UA: ${r.userAgent||r.user_agent||'-'}`,
    `í˜ì´ì§€: ${r.page||'-'}`,
    `ID: ${r.id}`
  ].join('\n');
  document.getElementById('detailBody').textContent = detail;
  document.getElementById('detailModal').style.display = 'flex';
}

// ë©”ëª¨ ëª¨ë‹¬ ë™ì‘
const memoModal = document.getElementById('memoModal');
let memoTargetId = null;
function openMemo(id){ memoTargetId=id; document.getElementById('memoText').value=''; memoModal.style.display='flex'; }
document.getElementById('saveMemo').onclick = async ()=>{
  if(!memoTargetId){ memoModal.style.display='none'; return; }
  try{
    await updateDoc(doc(db,'inquiries', memoTargetId), { memo: document.getElementById('memoText').value||'' });
    const t = ALL.find(x=>x.id===memoTargetId); if(t) t.memo = document.getElementById('memoText').value||'';
  }catch(err){ alert(err.message); }
  memoModal.style.display='none'; render();
};
document.addEventListener('click', (e)=>{
  if(e.target.matches('[data-close]')){
    memoModal.style.display='none';
    const dm = document.getElementById('detailModal');
    if(dm) dm.style.display='none';
  }
});

// CSV ë‚´ë³´ë‚´ê¸° (ë¡œì»¬ ALL ê¸°ì¤€)
document.getElementById('btnExport').onclick = ()=>{
  const csv = toCSV(ALL);
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download=`inquiries_${Date.now()}.csv`; a.click();
  URL.revokeObjectURL(url);
};

// ===== ìœ í‹¸ =====
function toCSV(rows){
  if(!rows.length) return '';
  const cols = ['createdAt','name','phone','brand','product','model','terms','message','status','referrer','userAgent','page','memo','id'];
  const header = cols.join(',');
  const lines = rows.map(r => cols.map(c => {
    let v = r[c];
    if (c === 'createdAt') {
      const dt = toDate(r.createdAt);
      v = dt ? dt.toISOString() : '';
    }
    if(typeof v === 'object' && v !== null) v = JSON.stringify(v);
    v = (v ?? '').toString().replaceAll('"','""');
    return `"${v}"`;
  }).join(','));
  return [header, ...lines].join('\n');
}

function esc(s){ return (s??'').toString().replace(/[&<>\"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
function fmtPhone(s){ if(!s) return ''; const d=(s+'').replace(/\D/g,''); if(d.length===10) return d.replace(/(\d{3})(\d{3})(\d{4})/,'$1-$2-$3'); if(d.length===11) return d.replace(/(\d{3})(\d{4})(\d{4})/,'$1-$2-$3'); return s; }
function toDate(v){ try{ return (v && typeof v.toDate==='function') ? v.toDate() : (v ? new Date(v) : null); }catch(_){ return null; } }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

</script>
</body>
</html>
